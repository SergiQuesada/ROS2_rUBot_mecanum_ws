<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ROS Web Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>
  <style>
    :root{
      --gap: 20px;
      --page-bg: #414141;
      --card-bd: #ccc;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--page-bg);
      color: #e6e6e6;
    }

    .connection-form {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: var(--gap);
    }
    .connection-form input[type="number"]{
      width: 70px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #bbb;
      background: #fff;
    }
    .connection-form button{
      padding: 8px 14px;
      border-radius: 6px;
      border: 1px solid #bbb;
      background: #f5f5f5;
      cursor: pointer;
    }
    .connection-form button.connected {
      background: #2ecc71;
      border-color: #2ecc71;
      color: #fff;
    }

    .dashboard {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-areas:
        "camera right"
        "map pos";
      gap: var(--gap);
      justify-items: center;
    }

    #camera-feed      { grid-area: camera; }
    .right-panel      { grid-area: right; display:flex; flex-direction:column; align-items:center; gap:8px;}
    .map-display      { grid-area: map; width: min(280px,100%);}
    .position-display { grid-area: pos;}

    .joystick-container {
      width: 200px; height: 200px;
      background-color: #ddd;
      border-radius: 50%;
      position: relative;
      overflow: hidden;
      touch-action: none;
    }

    .joy-vel {
      font-size: 0.9rem;
      color: #ddd;
      text-align: center;
    }

    .omega-wrap {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: #eee;
      font-size: 0.95rem;
      width: 100%;
      margin-top: 4px;
    }
    #omegaSlider {
      -webkit-appearance: none;
      appearance: none;
      width: 160px;
      height: 10px;
      border-radius: 6px;
      background: #666;
      outline: none;
    }
    #omegaSlider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px; height: 16px;
      border-radius: 50%;
      background: #f5f5f5;
      border: 2px solid #222;
      cursor: pointer;
    }
    #omegaSlider::-moz-range-thumb {
      width: 16px; height: 16px;
      border-radius: 50%;
      background: #f5f5f5;
      border: 2px solid #222;
      cursor: pointer;
    }

    .map-image {
      width: 100%;
      border: 1px solid var(--card-bd);
      border-radius: 5px;
      background-color: #e6e6e6;
    }
  </style>
</head>

<body>
  <div class="connection-form">
    <label for="robotNumber">Robot:</label>
    <input id="robotNumber" type="number" min="1" max="9" value="1"/>
    <button id="connectBtn" onclick="connectToROS()">Connect</button>
  </div>

  <div class="dashboard">
    <img id="camera-feed" class="image-view" width="360" height="270" alt="Camera Feed"/>

    <aside class="right-panel">
      <div class="joy-legend">Joystick</div>
      <div class="joystick-container" id="joystick_h"></div>
      <div class="joy-vel">vₓ: <span id="vx">0.00</span> m/s · vᵧ: <span id="vy">0.00</span> m/s</div>
      <div class="omega-wrap">
        <label for="omegaSlider">ω:</label>
        <input id="omegaSlider" type="range" min="-1" max="1" step="0.01" value="0"/>
        <span id="omegaVal">0.00</span> rad/s
      </div>
    </aside>

    <div class="map-display">
      <h3>Map + LiDAR</h3>
      <canvas id="map-canvas" class="map-image" width="200" height="200"></canvas>
    </div>

    <div class="position-display">
      <h3>Position & Orientation</h3>
      <p>X (m): <span id="position-x">0</span></p>
      <p>Y (m): <span id="position-y">0</span></p>
      <p>θ (º): <span id="rotation-z">0</span></p>
    </div>
  </div>

  <script>
    // --- constants ---
    const MAP_RESOLUTION=0.01,ROBOT_LEN_M=0.3,ROBOT_WID_M=0.2,maxSpeed=0.3,maxTurn=0.4;
    const SPEED_VECTOR_GAIN=0.5,distanceFactor=75;

    let ros,cmdVelTopic,currentLinearX=0,currentLinearY=0,currentAngularZ=0;
    let mapImage=new Image(),latestScan=null,lastRobotX=0,lastRobotY=0,lastRobotYaw=0;
    let lastRobotX_ros=0,lastRobotY_ros=0,odomCenterSet=false,yawOffsetSet=false;
    let odomCenterX=0,odomCenterY=0,yawOffset=0;

    function worldToPixel(x,y,W,H){return[W/2+(y/MAP_RESOLUTION),H/2-(x/MAP_RESOLUTION)];}
    function drawAxes(ctx,W,H){
      const cx=W/2,cy=H/2,metersPerTick=0.3,pxpm=1/MAP_RESOLUTION,tickPx=metersPerTick*pxpm;
      ctx.save();
      ctx.strokeStyle='red';ctx.beginPath();ctx.moveTo(cx,0);ctx.lineTo(cx,H);ctx.stroke();
      ctx.strokeStyle='green';ctx.beginPath();ctx.moveTo(0,cy);ctx.lineTo(W,cy);ctx.stroke();
      const tickLen=5;
      for(let i=1;i<=Math.floor(W/(2*tickPx));i++){
        ctx.beginPath();ctx.moveTo(cx+i*tickPx,cy-tickLen);ctx.lineTo(cx+i*tickPx,cy+tickLen);ctx.stroke();
        ctx.beginPath();ctx.moveTo(cx-i*tickPx,cy-tickLen);ctx.lineTo(cx-i*tickPx,cy+tickLen);ctx.stroke();
        ctx.beginPath();ctx.moveTo(cx-tickLen,cy-i*tickPx);ctx.lineTo(cx+tickLen,cy-i*tickPx);ctx.stroke();
        ctx.beginPath();ctx.moveTo(cx-tickLen,cy+i*tickPx);ctx.lineTo(cx+tickLen,cy+i*tickPx);ctx.stroke();
      }
      ctx.restore();
    }

    function quaternionToYaw(q){return Math.atan2(2*(q.w*q.z+q.x*q.y),1-2*(q.y*q.y+q.z*q.z));}

    function connectToROS(){
      const robotNum=parseInt(document.getElementById('robotNumber').value)||1;
      const host=window.location.hostname,scheme=location.protocol==='https:'?'wss':'ws';
      let rosbridgeAddress=host.startsWith("192.168.1.")?`${scheme}://192.168.1.${robotNum*10+4}:9090`:`${scheme}://${host}:9090`;
      ros=new ROSLIB.Ros({url:rosbridgeAddress});
      ros.on('connection',()=>{document.getElementById('connectBtn').classList.add('connected');setupTopics();setupControls();});
      ros.on('close',()=>document.getElementById('connectBtn').classList.remove('connected'));
    }

    function setupTopics(){
      cmdVelTopic=new ROSLIB.Topic({ros,name:'/cmd_vel',messageType:'geometry_msgs/msg/Twist'});
      new ROSLIB.Topic({ros,name:'/odom',messageType:'nav_msgs/msg/Odometry'})
      .subscribe(m=>{
        const p=m.pose.pose.position,o=m.pose.pose.orientation,yawAbs=quaternionToYaw(o);
        if(!odomCenterSet){odomCenterX=p.x;odomCenterY=p.y;odomCenterSet=true;}
        if(!yawOffsetSet){yawOffset=yawAbs;yawOffsetSet=true;}
        const dx=p.x-odomCenterX,dy=p.y-odomCenterY,yawRel=yawAbs-yawOffset;
        lastRobotX_ros=dx;lastRobotY_ros=dy;lastRobotX=dx;lastRobotY=-dy;lastRobotYaw=yawRel;
        document.getElementById('position-x').textContent=dx.toFixed(2);
        document.getElementById('position-y').textContent=(-dy).toFixed(2);
        document.getElementById('rotation-z').textContent=(yawRel*180/Math.PI).toFixed(1);
        drawRobotState(lastRobotX,lastRobotY,0,0,lastRobotYaw,latestScan);
      });
      new ROSLIB.Topic({ros,name:'/scan',messageType:'sensor_msgs/msg/LaserScan'}).subscribe(m=>latestScan=m);
    }

    function drawRobotState(robotX,robotY,velX,velY,yaw,scan){
      const c=document.getElementById('map-canvas'),ctx=c.getContext('2d'),W=c.width,H=c.height;
      ctx.clearRect(0,0,W,H);drawAxes(ctx,W,H);
      if(scan){const am=scan.angle_min,ai=scan.angle_increment;
        ctx.fillStyle='rgba(255,215,0,0.9)';
        scan.ranges.forEach((r,i)=>{if(r>scan.range_min&&r<scan.range_max){
          const a=am+i*ai,wx=lastRobotX_ros+r*Math.cos(yaw+a),wy=-lastRobotY_ros-r*Math.sin(yaw+a);
          const [px,py]=worldToPixel(wx,wy,W,H);ctx.fillRect(px,py,2,2);
        }});}
      const [cx,cy]=worldToPixel(robotX,robotY,W,H);
      const hx=ROBOT_LEN_M/2,hy=ROBOT_WID_M/2;
      ctx.beginPath();
      [[hx,hy],[hx,-hy],[-hx,-hy],[-hx,hy]].forEach(([xr,yr],i)=>{
        const xw=robotX+xr*Math.cos(yaw)-yr*Math.sin(yaw),yw=robotY+xr*Math.sin(yaw)+yr*Math.cos(yaw);
        const [px,py]=worldToPixel(xw,yw,W,H);i?ctx.lineTo(px,py):ctx.moveTo(px,py);
      });
      ctx.closePath();ctx.fillStyle='rgba(0,255,0,0.4)';ctx.strokeStyle='black';ctx.fill();ctx.stroke();
      const tip=[robotX+0.2*Math.cos(yaw),robotY+0.2*Math.sin(yaw)];
      const [tx,ty]=worldToPixel(...tip,W,H);
      ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(tx,ty);ctx.strokeStyle='blue';ctx.stroke();
    }

    function setupControls(){
      const j=nipplejs.create({zone:document.getElementById('joystick_h'),mode:'static',position:{left:'50%',top:'50%'},color:'red',size:150});
      j.on('move',(e,d)=>{const r=Math.min(d.distance/distanceFactor,1);currentLinearX=Math.sin(d.angle.radian)*maxSpeed*r;currentLinearY=-Math.cos(d.angle.radian)*maxSpeed*r;
        vx.textContent=currentLinearX.toFixed(2);vy.textContent=currentLinearY.toFixed(2);});
      j.on('end',()=>{currentLinearX=currentLinearY=0;vx.textContent=vy.textContent='0.00';});
      const slider=document.getElementById('omegaSlider'),val=document.getElementById('omegaVal');
      slider.addEventListener('input',()=>{currentAngularZ=-parseFloat(slider.value||0)*maxTurn;val.textContent=currentAngularZ.toFixed(2);});
      setInterval(()=>{cmdVelTopic&&cmdVelTopic.publish(new ROSLIB.Message({linear:{x:currentLinearX,y:currentLinearY,z:0},angular:{x:0,y:0,z:currentAngularZ}}));},50);
    }
  </script>
</body>
</html>
